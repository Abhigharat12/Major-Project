<% layout("/layouts/boilerplate.ejs") -%>

<!-- CSS -->
<style>
  .card {
    aspect-ratio: 10 / 8;
    border: 2px solid;
    background-color: #fff;
    position: relative;
    transition: 0.15s ease;
    cursor: pointer;
    padding: 0;
  }
  .card:before,
  .card:after {
    content: "";
    position: absolute;
    height: 100%;
    width: 100%;
    border: 4px solid;
    background-color: #fff;
    z-index: -1;
    transition: 0.15s ease;
    top: 0;
    left: 0;
    transform-origin: center center;
  }
  .card:before { transform: translateY(-2%) rotate(-6deg); }
  .card:after { transform: translateY(2%) rotate(6deg); }

  .image {
    width: 100%;
    height: 100%;
    background-color: #eee;
    border: 4px solid;
  }
  .feelalive-popup .maplibregl-popup-content {
    font-family: 'Segoe UI', sans-serif;
    padding: 10px 14px;
    background: linear-gradient(135deg, #ffffff, #f1f9ff);
    color: #333;
    border-radius: 8px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    min-width: 200px;
  }
  #map {
    height: 400px;
    border-radius: 10px;
    margin-bottom: 1rem;
  }
</style>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<body class="p-4">
<div class="container">
  <h3 class="mb-4 text-success text-center" style="margin-top: 1rem;">
    <%= listing.title %>
  </h3>

  <div class="row align-items-center gy-4">
    <!-- Left Column -->
    <div class="col-12 col-md-6">
      <ul class="list-group shadow-sm mb-4">
        <li class="list-group-item"><b>Title:</b> <%= listing.title %></li>
        <li class="list-group-item"><b>Owner:</b> <%= listing.owner ? listing.owner.username : "Unknown" %></li>
        <li class="list-group-item"><b>Description:</b> <%= listing.description %></li>
        <li class="list-group-item"><b>Price:</b> ₹ <%= listing.price ? listing.price.toLocaleString("en-IN") : "500" %></li>
        <li class="list-group-item"><b>Location:</b> <%= listing.location %></li>
        <li class="list-group-item"><b>Country:</b> <%= listing.country %></li>
      </ul>

      <div class="d-flex flex-wrap gap-2">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">Edit</a>
        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="display:inline;">
          <button class="btn btn-danger">Delete</button>
        </form>
        <button id="payBtn" class="btn btn-success">
          Pay ₹<%= listing.price ? listing.price.toLocaleString("en-IN") : "500" %>
        </button>
      </div>
    </div>

    <!-- Right Column (Image) -->
    <div class="col-12 col-md-6 d-flex justify-content-center">
      <div class="position-relative stack" style="max-width: 500px;">
        <div class="card d-flex align-items-center justify-content-center">
          <% if (listing.image && listing.image.length > 0) { %>
            <div class="position-relative w-100 h-100">
              <img id="listingImage" 
                   src="<%= listing.image[0].url %>" 
                   class="d-block w-100 rounded"
                   style="max-height: 400px; object-fit: cover;" />
              <% if (listing.image.length > 1) { %>
                <button id="prevBtn" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y">&#10094;</button>
                <button id="nextBtn" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y">&#10095;</button>
              <% } %>
            </div>
          <% } else { %>
            <div class="image d-flex align-items-center justify-content-center text-muted p-5">
              No image available
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews -->
  <div class="mt-5 p-4 bg-light rounded shadow-sm">
    <h4 class="mb-4 text-primary">Leave a Review</h4>
    <form method="POST" action="/listings/<%= listing._id %>/reviews" novalidate>
      <fieldset class="starability-slot mb-4">
        <legend class="form-label fw-semibold">Rating</legend>
        <% for(let i=1; i<=5; i++){ %>
          <input type="radio" id="rate-<%= i %>" name="review[rating]" value="<%= i %>" />
          <label for="rate-<%= i %>"><%= i %> star</label>
        <% } %>
      </fieldset>
      <div class="mb-3">
        <label for="comment">Comment</label>
        <textarea name="review[comment]" id="comment" rows="4" class="form-control" required></textarea>
      </div>
      <button class="btn btn-primary">Add Review</button>
    </form>
  </div>

  <h4 class="mt-4">All Reviews</h4>
  <div class="row g-4">
    <% listing.reviews.forEach(review => { 
         const avatarUrl = (review.author && review.author.gender === "female")
            ? "https://cdn-icons-png.flaticon.com/512/2922/2922561.png"
            : "https://cdn-icons-png.flaticon.com/512/2922/2922510.png";
    %>
      <div class="col-md-6">
        <div class="p-4 bg-white border rounded shadow-sm">
          <div class="d-flex align-items-center mb-3">
            <img src="<%= avatarUrl %>" class="rounded-circle me-3" width="50" height="50" />
            <div>
              <h6>@<%= review.author ? review.author.username : "Unknown" %></h6>
              <small><%= review.createdAt ? new Date(review.createdAt).toLocaleDateString("en-IN") : "No date" %></small>
            </div>
          </div>
          <p>Rated: <%= review.rating %> star(s)</p>
          <p><%= review.comment %></p>
          <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
            <button class="btn btn-sm btn-outline-danger w-100">Delete Review</button>
          </form>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Map -->
  <h3 class="mt-4">Location for <%= listing.title %></h3>
  <div id="map"></div>
</div>

<!-- Cashfree SDK -->
<script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const payBtn = document.getElementById("payBtn");
  if(payBtn){
    payBtn.onclick = async function(){
      // const amount = <%= listing.price ? listing.price : 500 %>;
      // Fix: wrap EJS output in quotes for valid JS
      const amount = "<%= listing.price ? listing.price : 500 %>";
      const customer = {
        id: "<%= currentUser ? currentUser._id : '' %>",
        name: "<%= currentUser ? currentUser.username : 'Guest' %>",
        email: "<%= currentUser ? currentUser.email : 'guest@example.com' %>",
      };
      const listingId = "<%= listing._id %>";
      const res = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, customer, listingId })
      });
      const responseData = await res.json();
      if (!responseData.data || !responseData.data.payment_session_id) {
        alert("Payment error: " + (responseData.error || "Unknown error"));
        return;
      }

      const cashfree = Cashfree({ mode: "sandbox" });
      cashfree.checkout({ paymentSessionId: responseData.data.payment_session_id, redirectTarget: "_self" });
    }
  }
});
</script>
